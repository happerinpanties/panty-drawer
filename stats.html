<!DOCTYPE html>
<html>
<head>
  <title>Panty Drawer - Stats</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    h2 { margin-top: 40px; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #f5f5f5; }
  </style>
</head>
<body>

<h1>Mood & Wear Stats</h1>

<h2>Color by Day Rating</h2>
<table id="colorTable">
  <thead>
    <tr>
      <th>Day Rating</th>
      <th>Color</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>State by Day Rating</h2>
<table id="stateTable">
  <thead>
    <tr>
      <th>Day Rating</th>
      <th>State</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Wear Count by Color</h2>
<table id="colorCountTable">
  <thead>
    <tr>
      <th>Color</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Wear Count by Style</h2>
<table id="styleCountTable">
  <thead>
    <tr>
      <th>Style</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Wear Count by Brand</h2>
<table id="brandCountTable">
  <thead>
    <tr>
      <th>Brand</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Wear Count by Fabric</h2>
<table id="fabricCountTable">
  <thead>
    <tr>
      <th>Fabric</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Color by Year-Month</h2>
<canvas id="colorMonthChart" height="120"></canvas>

<h1>Current Drawer Counts</h1>

<h2>Current Drawer Counts by Color</h2>
<canvas id="drawerColorChart" height="120"></canvas>

<h2>Current Drawer Counts by Style</h2>
<canvas id="drawerStyleChart" height="120"></canvas>

<h2>Current Drawer Counts by Brand</h2>
<canvas id="drawerBrandChart" height="120"></canvas>

<h2>Current Drawer Counts by Fabric</h2>
<canvas id="drawerFabricChart" height="120"></canvas>

<script>
const client = window.supabase.createClient(
  'https://rkocfrsaeeyxgfdxeiqz.supabase.co',
  'sb_publishable_yp7myP1S5wmYLQrgwNWxhg_IfZHdeZj'
);

/* ---------------------------
   Helper Render Functions
--------------------------- */

function renderSimpleTable(tableId, counts) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';

  Object.entries(counts)
    .sort((a,b) => b[1] - a[1])
    .forEach(([label, count]) => {
      tbody.innerHTML += `
        <tr>
          <td>${label}</td>
          <td>${count}</td>
        </tr>
      `;
    });
}

function renderColorMonthChart(counts) {
  const monthNames = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  const monthColorMap = {};
  const allColors = new Set();

  // Rebuild structure into { month: { color: count } }
  Object.entries(counts).forEach(([key, count]) => {
    const [yymm, color] = key.split("-");
    const year = "20" + yymm.slice(0,2);
    const monthIndex = parseInt(yymm.slice(2,4)) - 1;
    const monthLabel = `${monthNames[monthIndex]} ${year}`;

    if (!monthColorMap[monthLabel]) {
      monthColorMap[monthLabel] = {};
    }

    monthColorMap[monthLabel][color] = count;
    allColors.add(color);
  });

  // Sort months descending (most recent first)
  const sortedMonths = Object.keys(monthColorMap)
    .sort((a, b) => new Date(b) - new Date(a));

  const colorsArray = Array.from(allColors);

const colorMap = {
  Pink: "#ff6fae",
  Purple: "#8e44ad",
  Red: "#e74c3c",
  White: "#ecf0f1",
  Black: "#2c3e50",
  Yellow: "#f1c40f",
  Orange: "#e67e22",
  Green: "#27ae60",
  Blue: "#3498db",
  Grey: "#7f8c8d",
  "Animal Print": "#a67c52",   // tan/brown
  Multicolor: "#9b59b6"        // vibrant purple fallback
};

const datasets = colorsArray.map(color => {
  const bgColor = colorMap[color] || "#95a5a6"; // fallback gray

  return {
    label: color,
    data: sortedMonths.map(month => 
      monthColorMap[month][color] || 0
    ),
    backgroundColor: bgColor,
    borderColor: bgColor,
    borderWidth: 1
  };
});

  const ctx = document.getElementById('colorMonthChart').getContext('2d');

  if (window.colorMonthChartInstance) {
    window.colorMonthChartInstance.destroy();
  }

window.colorMonthChartInstance = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: sortedMonths,
    datasets: datasets
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top' },
      tooltip: {
        mode: 'index',
        intersect: false
      }
    },
    interaction: {
      mode: 'index',
      intersect: false
    },
    scales: {
      x: {
        stacked: true
      },
      y: {
        stacked: true,
        beginAtZero: true,
        ticks: {
          precision: 0
        }
      }
    }
  }
});
}

function renderSimpleBarChart(canvasId, counts) {
  const labels = Object.keys(counts);
  const values = Object.values(counts);

  const ctx = document
    .getElementById(canvasId)
    .getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Count',
        data: values
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
}

/* ---------------------------
   Mood: Color by Day Rating
--------------------------- */

async function loadColorStats() {
  const { data, error } = await client
    .from('wear_mood')
    .select(`
      day_rating,
      wear_history (
        panties (
          color
        )
      )
    `);

  if (error) {
    console.error("Color stats error:", error);
    return;
  }

  const counts = {};

  data.forEach(row => {
    const rating = row.day_rating;
    const color = row.wear_history?.panties?.color;

    if (!rating || !color) return;

    const key = rating + "-" + color;
    counts[key] = (counts[key] || 0) + 1;
  });

  const tbody = document.querySelector('#colorTable tbody');
  tbody.innerHTML = '';

  Object.entries(counts)
    .sort((a,b) => b[0].localeCompare(a[0]))
    .forEach(([key, count]) => {
      const [rating, color] = key.split("-");
      tbody.innerHTML += `
        <tr>
          <td>${rating}</td>
          <td>${color}</td>
          <td>${count}</td>
        </tr>
      `;
    });
}

/* ---------------------------
   Mood: State by Day Rating
--------------------------- */

async function loadStateStats() {
  const { data, error } = await client
    .from('wear_mood')
    .select('day_rating, state')
    .not('state', 'is', null);

  if (error) {
    console.error("State stats error:", error);
    return;
  }

  const counts = {};

  data.forEach(row => {
    const key = row.day_rating + "-" + row.state;
    counts[key] = (counts[key] || 0) + 1;
  });

  const tbody = document.querySelector('#stateTable tbody');
  tbody.innerHTML = '';

  Object.entries(counts)
    .sort((a,b) => b[0].localeCompare(a[0]))
    .forEach(([key, count]) => {
      const [rating, state] = key.split("-");
      tbody.innerHTML += `
        <tr>
          <td>${rating}</td>
          <td>${state}</td>
          <td>${count}</td>
        </tr>
      `;
    });
}


/* ---------------------------
   Drawer Counts
--------------------------- */

async function loadDrawerCounts() {
  const { data, error } = await client
    .from('panties')
    .select(`
      color,
      styles ( name ),
      brands ( name ),
      fabrics ( name )
    `)
    .eq('status', 'Clean');

  if (error) {
    console.error('Drawer stats error:', error);
    return;
  }

  const colorCounts = {};
  const styleCounts = {};
  const brandCounts = {};
  const fabricCounts = {};

  data.forEach(p => {
    // COLOR
    if (p.color)
      colorCounts[p.color] = (colorCounts[p.color] || 0) + 1;

    // STYLE
    if (Array.isArray(p.styles)) {
      p.styles.forEach(s => {
        if (s?.name)
          styleCounts[s.name] = (styleCounts[s.name] || 0) + 1;
      });
    } else if (p.styles?.name) {
      styleCounts[p.styles.name] =
        (styleCounts[p.styles.name] || 0) + 1;
    }

    // BRAND
    if (Array.isArray(p.brands)) {
      p.brands.forEach(b => {
        if (b?.name)
          brandCounts[b.name] =
            (brandCounts[b.name] || 0) + 1;
      });
    } else if (p.brands?.name) {
      brandCounts[p.brands.name] =
        (brandCounts[p.brands.name] || 0) + 1;
    }

    // FABRIC
    if (Array.isArray(p.fabrics)) {
      p.fabrics.forEach(f => {
        if (f?.name)
          fabricCounts[f.name] =
            (fabricCounts[f.name] || 0) + 1;
      });
    } else if (p.fabrics?.name) {
      fabricCounts[p.fabrics.name] =
        (fabricCounts[p.fabrics.name] || 0) + 1;
    }
  });

  renderSimpleBarChart('drawerColorChart', colorCounts);
  renderSimpleBarChart('drawerStyleChart', styleCounts);
  renderSimpleBarChart('drawerBrandChart', brandCounts);
  renderSimpleBarChart('drawerFabricChart', fabricCounts);
}


/* ---------------------------
   Wear Counts
--------------------------- */

async function loadWearCounts() {
  const { data, error } = await client
    .from('wear_history')
    .select(`
      worn_at,
      panties (
        color,
        styles ( name ),
        brands ( name ),
        fabrics ( name )
      )
    `);

  if (error) {
    console.error("Wear count error:", error);
    return;
  }

  const colorCounts = {};
  const styleCounts = {};
  const brandCounts = {};
  const fabricCounts = {};
  const colorMonthCounts = {};

  data.forEach(row => {
    const p = row.panties;
    if (!p) return;

    if (p.color) colorCounts[p.color] = (colorCounts[p.color] || 0) + 1;
// STYLE
if (Array.isArray(p.styles)) {
  p.styles.forEach(s => {
    if (s?.name)
      styleCounts[s.name] = (styleCounts[s.name] || 0) + 1;
  });
} else if (p.styles?.name) {
  styleCounts[p.styles.name] = (styleCounts[p.styles.name] || 0) + 1;
}

// BRAND
if (Array.isArray(p.brands)) {
  p.brands.forEach(b => {
    if (b?.name)
      brandCounts[b.name] = (brandCounts[b.name] || 0) + 1;
  });
} else if (p.brands?.name) {
  brandCounts[p.brands.name] = (brandCounts[p.brands.name] || 0) + 1;
}

// FABRIC
if (Array.isArray(p.fabrics)) {
  p.fabrics.forEach(f => {
    if (f?.name)
      fabricCounts[f.name] = (fabricCounts[f.name] || 0) + 1;
  });
} else if (p.fabrics?.name) {
  fabricCounts[p.fabrics.name] = (fabricCounts[p.fabrics.name] || 0) + 1;
}

    if (row.worn_at && p.color) {
      const date = new Date(row.worn_at);
      const yymm =
        String(date.getFullYear()).slice(2) +
        String(date.getMonth() + 1).padStart(2, '0');

      const key = yymm + "-" + p.color;
      colorMonthCounts[key] = (colorMonthCounts[key] || 0) + 1;
    }
  });

  renderSimpleTable("colorCountTable", colorCounts);
  renderSimpleTable("styleCountTable", styleCounts);
  renderSimpleTable("brandCountTable", brandCounts);
  renderSimpleTable("fabricCountTable", fabricCounts);
  renderColorMonthChart(colorMonthCounts);
}

/* ---------------------------
   Initialize
--------------------------- */

loadColorStats();
loadStateStats();
loadWearCounts();
loadDrawerCounts();

</script>

</body>
</html>